#include <iostream>
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <cmath>

double dydx(double x, double f, double *rho, int n)
{
  int i;                  // Counter
  double c_HII = 3.;      // Clumping fraction for the IGM at z=3, T=20,000K 
  double alpha_B;         // Recombination coefficient 
  double Y_p = 0.24;      // Fraction of Helium 
  double X_p = 1. - Y_p;  // Fraction of Hydrogen   

  double *n_h_avg = new double[n];   // Hydrogen number density in each cell 
  double *n_dot_ion = new double[n]; // Ionizing photon rate
  double *t_rec_inv = new double[n]; // Recombination time
  double *new_Q = new double[n];     // New value of dQ

  // Set the constants needed for (t_rec)**(-1)
  alpha_B = 2.6*pow(10.,-13.);

  // Convert the total gas density to just the Hydrogen gas density
  for (i=0;i<n;i++)
    {
      n_h_avg[i] = rho[i]*X_p;
      n_dot_ion = 0.5;
      t_rec_inv[i] = c_HII*alpha_B*(1. + (Y_p/(4.*X_p)))*n_h_avg[i]*64.;
      new_Q[i] = (n_dot_ion[i]/n_h_avg[i]) - (f*t_rec_inv[i]);
    }

  // Return the spatially dependent solution
  return new_Q;
}
